name: OrangeFox [OFRP] Builder - Script Method

on:
  workflow_dispatch:
    inputs:
      MANIFEST_BRANCH:
        description: 'OrangeFox Manifest Branch'
        required: true
        default: '12.1'
        type: choice
        options:
        - '12.1'
        - '11.0'
      DEVICE_TREE:
        description: 'Device Tree URL'
        required: true
        default: 'https://github.com/nitheshd30/OFRP-device_nothing_Spacewar.git'
      DEVICE_TREE_BRANCH:
        description: 'Device Tree Branch'
        required: true
        default: 'master'
      DEVICE_PATH:
        description: 'Device Path'
        required: true
        default: 'device/nothing/Spacewar'
      DEVICE_NAME:
        description: 'Device Codename'
        required: true
        default: 'Spacewar'
      BUILD_TARGET:
        description: 'Build Target'
        required: true
        default: 'recovery'
        type: choice
        options:
        - recovery
        - boot
        - vendor_boot

jobs:
  build:
    name: Build OrangeFox by ${{ github.actor }}
    runs-on: ubuntu-latest
    if: github.event.repository.owner.id == github.event.sender.id
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    permissions:
      contents: write
    steps:
    - name: Check Out
      uses: actions/checkout@v4

    - name: Cleanup Space
      uses: rokibhasansagar/slimhub_actions@main

    - name: Prepare Environment
      run: |
        sudo apt-get update
        sudo apt-get -y install git aria2 python3 python2 git-lfs gnupg flex bison gperf build-essential zip curl zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 lib32ncurses5-dev x11proto-core-dev libx11-dev lib32z1-dev libgl1-mesa-dev libxml2-utils xsltproc unzip fontconfig

    - name: Install OpenJDK 11
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '11'

    - name: Sync OrangeFox Sources (Script Method)
      run: |
        mkdir -p ~/OrangeFox_sync
        cd ~/OrangeFox_sync
        git clone https://gitlab.com/OrangeFox/sync.git
        cd sync
        
        # Execute the sync script
        # We set the path to ${{ github.workspace }}/fox_${{ github.event.inputs.MANIFEST_BRANCH }}
        ./orangefox_sync.sh --branch ${{ github.event.inputs.MANIFEST_BRANCH }} --path ${{ github.workspace }}/fox_${{ github.event.inputs.MANIFEST_BRANCH }}

    - name: Clone Device Tree
      run: |
        # Navigate to the synced directory
        cd ${{ github.workspace }}/fox_${{ github.event.inputs.MANIFEST_BRANCH }}
        
        # Clone Device Tree
        git clone ${{ github.event.inputs.DEVICE_TREE }} ./${{ github.event.inputs.DEVICE_PATH }} -b ${{ github.event.inputs.DEVICE_TREE_BRANCH }}

        # Clone Kernel/Vendor (Adjust if your tree has prebuilts)
        git clone https://github.com/Spacewar-dev/android_kernel_nothing_sm7325.git ./kernel/nothing/sm7325 -b 14.0
        git clone https://github.com/TheMuppets/proprietary_vendor_nothing_Spacewar.git ./vendor/nothing/Spacewar -b lineage-20

    - name: Build OrangeFox
      run: |
        cd ${{ github.workspace }}/fox_${{ github.event.inputs.MANIFEST_BRANCH }}
        
        # Setup Environment
        set +e
        source build/envsetup.sh
        set -e
        
        # Exports
        export ALLOW_MISSING_DEPENDENCIES=true
        export FOX_USE_TWRP_RECOVERY_IMAGE_BUILDER=1
        export LC_ALL="C"
        
        # Lunch
        lunch twrp_${{ github.event.inputs.DEVICE_NAME }}-eng
        
        # Build
        mka adbd recoveryimage -j$(nproc --all)

    - name: Set Release Properties
      run: |
        echo "BUILD_DATE=$(date +%Y%m%d)" >> $GITHUB_ENV
        echo "FOX_BUILD_DIR=${{ github.workspace }}/fox_${{ github.event.inputs.MANIFEST_BRANCH }}/out/target/product/${{ github.event.inputs.DEVICE_NAME }}" >> $GITHUB_ENV

    - name: Upload to Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ${{ env.FOX_BUILD_DIR }}/OrangeFox*.zip
          ${{ env.FOX_BUILD_DIR }}/recovery.img
          ${{ env.FOX_BUILD_DIR }}/boot.img
        name: OrangeFox ${{ github.event.inputs.DEVICE_NAME }} - ${{ env.BUILD_DATE }}
        tag_name: ${{ github.run_id }}
        body: |
          **Build Info**
          * Manifest: ${{ github.event.inputs.MANIFEST_BRANCH }}
          * Device: [Tree](${{ github.event.inputs.DEVICE_TREE }}/tree/${{ github.event.inputs.DEVICE_TREE_BRANCH }})
