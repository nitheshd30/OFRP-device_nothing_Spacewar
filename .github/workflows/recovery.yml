name: Build SHRP Recovery

on:
  workflow_dispatch:
    inputs:
      MANIFEST_URL:
        description: 'Manifest URL'
        required: true
        default: 'https://github.com/nitheshd30/SHRP_Manifest.git'
      MANIFEST_BRANCH:
        description: 'Manifest Branch'
        required: true
        default: 'v3_11.0'
      DEVICE_TREE_URL:
        description: 'Device Tree URL'
        required: true
        default: 'https://github.com/nitheshd30/OFRP-device_nothing_Spacewar.git'
      DEVICE_TREE_BRANCH:
        description: 'Device Tree Branch'
        required: true
        default: 'main'
      DEVICE_PATH:
        description: 'Device Path'
        required: true
        default: 'device/nothing/Spacewar'
      DEVICE_NAME:
        description: 'Device Name (e.g. Spacewar)'
        required: true
        default: 'Spacewar'
      MAKEFILE_NAME:
        description: 'Makefile Name (without .mk)'
        required: true
        default: 'twrp_Spacewar'
      BUILD_TARGET:
        description: 'Build Target'
        required: true
        default: 'recoveryimage'

jobs:
  build:
    runs-on: ubuntu-20.04
    permissions:
      contents: write
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Free Disk Space (Manual)
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo apt-get clean
        echo "Disk space cleared."

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git-core gnupg flex bison build-essential zip curl zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 libncurses5 lib32ncurses5-dev x11proto-core-dev libx11-dev lib32z1-dev libgl1-mesa-dev libxml2-utils xsltproc unzip fontconfig

    - name: Setup Repo Tool
      run: |
        mkdir -p ~/bin
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
        chmod a+x ~/bin/repo
        echo "$HOME/bin" >> $GITHUB_PATH
        git config --global user.name "GitHub Action"
        git config --global user.email "action@github.com"
        git config --global color.ui false

    - name: Initialize Manifest
      run: |
        mkdir workspace
        cd workspace
        repo init -u ${{ inputs.MANIFEST_URL }} -b ${{ inputs.MANIFEST_BRANCH }} --depth=1

    - name: Repo Sync
      run: |
        cd workspace
        repo sync -j$(nproc --all) --force-sync

    - name: Clone Device Tree
      run: |
        cd workspace
        git clone ${{ inputs.DEVICE_TREE_URL }} -b ${{ inputs.DEVICE_TREE_BRANCH }} ${{ inputs.DEVICE_PATH }}

    - name: Build Recovery
      run: |
        cd workspace
        export ALLOW_MISSING_DEPENDENCIES=true
        source build/envsetup.sh
        lunch ${{ inputs.MAKEFILE_NAME }}-eng
        mka ${{ inputs.BUILD_TARGET }}

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: SHRP-Recovery-${{ inputs.DEVICE_NAME }}
        path: |
          workspace/out/target/product/${{ inputs.DEVICE_NAME }}/*.img
          workspace/out/target/product/${{ inputs.DEVICE_NAME }}/*.zip
      uses: ncipollo/release-action@v1.11.1
      with:
        artifacts: workspace/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/${{ github.event.inputs.MANIFEST_BRANCH }}*.img
        name: Unofficial-Alpha SHRP for ${{ github.event.inputs.DEVICE_NAME }} - Build ${{ steps.props.outputs.date }} / ${{ github.run_id }}
        draft: false
        prerelease: true
        tag: ${{ github.run_id }}-${{ steps.props.outputs.date }}
        token: ${{ secrets.GITHUB_TOKEN }}
        body: |
          Device: ${{ github.event.inputs.DEVICE_NAME }}
          Manifest: ${{ github.event.inputs.MANIFEST_URL }} -b ${{ github.event.inputs.MANIFEST_BRANCH }}
          Status: Alpha - Test it Yourself.
    - name: Clone LDChecker
      run: |
        git clone https://github.com/cd-Spidey/Random ./ldcheck
        cd ldcheck/extract-tools
        mv -n qseecomd ${GITHUB_WORKSPACE}/workspace/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/recovery/root/system/bin/
        mv -n libneeds ${GITHUB_WORKSPACE}/workspace/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/recovery/root/
        mv -n ldcheck ${GITHUB_WORKSPACE}/workspace/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/recovery/root/
        echo "Done moving essentials in checking missing dependencies."
      continue-on-error: true

    - name: Run LDCheck
      run: |
        cd workspace/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/recovery/root
        python3 ldcheck -p system/lib64:vendor/lib64:system/lib:vendor/lib -d ${{ github.event.inputs.FILE_TO_CHECK }}
        echo "Done checking missing dependencies. Review, and reconfigure your tree."
      continue-on-error: true
